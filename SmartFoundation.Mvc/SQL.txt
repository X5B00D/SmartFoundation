USE [DATACORE]
GO
/****** Object:  StoredProcedure [dbo].[GetSessionInfoForMVC]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[GetSessionInfoForMVC]
    @UserID Nvarchar(20),
    @Password Nvarchar(200),
    @hostName Nvarchar(200)

AS
BEGIN
    SET NOCOUNT ON;


    DECLARE @Salt VARBINARY(32);
    DECLARE @StoredHash VARBINARY(64);
    DECLARE @PasswordResult int

  -- هل يوجد كلمة مرور للمستخدم؟
IF NOT EXISTS (
    SELECT 1 
    FROM DATACORE.dbo.userPassword us
    WHERE us.IDNumber_FK = @UserID and us.userPasswordActive = 1
)
BEGIN
    SET @PasswordResult = 3;   -- لا يوجد كلمة مرور
END
ELSE
BEGIN
    -- جلب الهاش والسولت
    SELECT 
        @Salt = PasswordSalt,
        @StoredHash = PasswordHash
    FROM DATACORE.dbo.userPassword
    WHERE IDNumber_FK = @UserID;

    -- فحص كلمة المرور
    IF @StoredHash = HASHBYTES('SHA2_256', @Salt + CAST(@Password AS VARBINARY(200)))
    BEGIN
        SET @PasswordResult = 1;  -- كلمة المرور صحيحة
    END
    ELSE
    BEGIN
        SET @PasswordResult = 0;  -- كلمة المرور خاطئة
    END
END

    DECLARE @GeneralNo bigint
         if(select count(us.userID) from DATACORE.dbo.[User] us where us.IDNumber = @UserID) > 0
             begin
                 set @GeneralNo = (select TOP(1) us.userID from DATACORE.dbo.[User] us where us.IDNumber = @UserID order by us.entryDate desc)
             END
         ELSE
             BEGIN
                 set @GeneralNo = -99
             END
    -- Create a temporary table to store the department info
    DECLARE @DepartmentInfo TABLE (
        UserID bigINT,
        DepartmentName NVARCHAR(255),
		DeptCode nvarchar(20),
		IdaraID INT
    );


	  DECLARE @ThameInfo TABLE (
        UserID bigINT,
        ThameName NVARCHAR(255)
    );
    
    -- Get the department info first
    INSERT INTO @DepartmentInfo (UserID, DepartmentName, DeptCode,IdaraID)
    SELECT TOP 1 
        udsd.userID, 
        dsd.DepartmentName,
		d.deptCode,
		d.idaraID_FK
    FROM dbo.V_GetFullStructureForDSD dsd
    INNER JOIN dbo.V_GetListUsersInDSD udsd ON dsd.DSDID = udsd.DSDID
	INNER JOIN dbo.Department d ON dsd.DepartmentID = d.deptID
    WHERE udsd.userID = @GeneralNo;


	INSERT INTO @ThameInfo (UserID, ThameName)
            SELECT TOP 1 
                   @GeneralNo,
                   ISNULL(
                        m.MvcThameName,
                        'default'
                   ) AS ThameName
            FROM DATACORE.dbo.MvcThameUser u
            LEFT JOIN DATACORE.dbo.MvcThame m 
                   ON u.MvcThameID_FK = m.MvcThameID
            WHERE u.UserID_FK = @GeneralNo
              AND u.MvcThameUserActive = 1
              AND m.MvcThameActive = 1;

                -- إذا لم يرجع السطر السابق أي نتيجة → إدراج default يدويًا
            IF NOT EXISTS (SELECT 1 FROM @ThameInfo WHERE UserID = @GeneralNo)
            BEGIN
                INSERT INTO @ThameInfo (UserID, ThameName)
                VALUES (@GeneralNo, 'default');
            END


     

    
    -- Combine the user and department information along with photo from Payroll database
    if(@GeneralNo = -99)
    
     BEGIN
          select
            0 as userActive,
            N'عذرا لايوجد حساب مسجل بالنظام لصاحب الهوية رقم : '+@UserID as Message_
                
     END
    
    

     ELSE
           
      begin

      

    if(select Count(*) From DATACORE.dbo.[User] uu where uu.userID = @GeneralNo and uu.userActive = 1) > 0
                begin



                if(select Count(*) FROM dbo.[User] u
                    LEFT JOIN @DepartmentInfo d ON u.userID = d.UserID
                	LEFT JOIN @ThameInfo t ON u.userID = t.UserID
                    WHERE u.userID = @GeneralNo and u.userActive = 1 and d.IdaraID is not null and d.DepartmentName is not null) > 0
                    begin

                    if(@PasswordResult = 1)
                    begin
                    SELECT 
                        CONCAT_WS(' ', u.fristName_A, u.secondName_A, u.lastName_A) AS fullName, 
                        u.userID,
                		d.IdaraID,
                        d.DepartmentName,
                        (SELECT Photo FROM DATACORE.dbo.UserPhoto up WHERE up.userID_FK = @GeneralNo) AS Photo,
                		case when t.ThameName is null Then 'default'
                		else t.ThameName
                		END ThameName,
                		d.DeptCode,
                        u.IDNumber,
                        u.userActive,
                        N'مرحبا بك : '+CONCAT_WS(' ', u.fristName_A, u.secondName_A, u.lastName_A)+N' تم تسجيل دخولك للنظام في '+convert(nvarchar(50),GETDATE(),111)+N' الساعة ' +convert(nvarchar(50),GETDATE(),108) as Message_
                    FROM dbo.[User] u
                    LEFT JOIN @DepartmentInfo d ON u.userID = d.UserID
                	LEFT JOIN @ThameInfo t ON u.userID = t.UserID
                    WHERE u.userID = @GeneralNo and u.userActive = 1

                    end
                else if(@PasswordResult = 0)
                    begin

                     select
                        0 as userActive,
                         N'عذرا اسم المستخدم او كلمة المرور غير صحيحة' as Message_
                    end

                    else if(@PasswordResult = 3)
                    begin

                     select
                        
                        0 as userActive,
                         N'يجب اعادة ضبط كلمة المرور للمستخدم' as Message_
                    end


                    end
                  else
                     begin

                     select
                        0 as userActive,
                        N'عذرا يوجد خطأ بالهيكل الاداري لصاحب الهوية رقم : '+@UserID as Message_

                     end
                END
           ELSE
                BEGIN
                      select
                        0 as userActive,
                        N'عذرا لايوجد حساب نشط بالنظام لصاحب الهوية رقم : '+@UserID as Message_

                
                END

    end     
    
END;
GO
/****** Object:  StoredProcedure [dbo].[ListOfMenuByUser_MVC]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
create PROCEDURE [dbo].[ListOfMenuByUser_MVC] 
	-- Add the parameters for the stored procedure here
	@generalNo int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


select alls.MPID,alls.menuName_A,alls.MPSerial,alls.MPLink ,alls.parentMenuID_FK,alls.programID,isnull(parentMenuID_FK ,programID ) parents,alls.Levels, alls.MPIcon FROM (

--sub1
select m1.menuID MPID,m1.menuName_A,m1.menuSerial MPSerial,m1.menuLink MPLink ,m1.parentMenuID_FK,m1.programID_FK + 10000 programID,isnull(null ,null ) parents,
case 
when m1.parentMenuID_FK is null and m1.programID_FK is not null then 2
when m1.parentMenuID_FK is not null then 3

END Levels
, null MPIcon
from kfmc.dbo.GetListSubMenuNo1(@generalNo) m1
where m1.menuActive = 1
union 


select m2.menuID MPID,m2.menuName_A,m2.menuSerial MPSerial,m2.menuLink MPLink ,m2.parentMenuID_FK,m2.programID_FK + 10000 programID,isnull(null ,null ) parents,
case 
when m2.parentMenuID_FK is null and m2.programID_FK is not null then 2
when m2.parentMenuID_FK is not null then 3

END Levels
, null MPIcon
from kfmc.dbo.GetListSubMenuNo2(@generalNo) m2
where m2.menuActive = 1

union 


	select 
	pp.programID+10000 MPID,pp.programName_A menuName_A,pp.programSerial MPSerial,pp.programLink MPLink,null parentMenuID_FK,null programID,isnull(null ,null ) parents,1 Levels , pp.programIcon MPIcon
	from kfmc.dbo.Program pp
	where pp.programID in
	(
	select m22.programID_FK 
	from kfmc.dbo.GetListSubMenuNo2(@generalNo) m22
	where m22.menuActive = 1
	)
	or

	pp.programID in
	(
	select m11.programID_FK 
	from kfmc.dbo.GetListSubMenuNo1(@generalNo) m11
	where m11.menuActive = 1
	)



	) alls 
	order by alls.Levels



END

GO
/****** Object:  StoredProcedure [dbo].[Masters_CRUD]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Masters_CRUD]
    @pageName_ NVARCHAR(400),
    @ActionType NVARCHAR(100) , -- INSERT, UPDATE, DELETE
	@idaraID INT,
	@entrydata INT,
	@hostName	  NVARCHAR(4000) = NULL,
    @parameter_01 NVARCHAR(4000) = NULL,
    @parameter_02 NVARCHAR(4000) = NULL,
    @parameter_03 NVARCHAR(4000) = NULL,
    @parameter_04 NVARCHAR(4000) = NULL,
    @parameter_05 NVARCHAR(4000) = NULL,
    @parameter_06 NVARCHAR(4000) = NULL,
    @parameter_07 NVARCHAR(4000) = NULL,
    @parameter_08 NVARCHAR(4000) = NULL,
    @parameter_09 NVARCHAR(4000) = NULL,
    @parameter_10 NVARCHAR(4000) = NULL,
    @parameter_11 NVARCHAR(4000) = NULL,
    @parameter_12 NVARCHAR(4000) = NULL,
    @parameter_13 NVARCHAR(4000) = NULL,
    @parameter_14 NVARCHAR(4000) = NULL,
    @parameter_15 NVARCHAR(4000) = NULL,
    @parameter_16 NVARCHAR(4000) = NULL,
    @parameter_17 NVARCHAR(4000) = NULL,
    @parameter_18 NVARCHAR(4000) = NULL,
    @parameter_19 NVARCHAR(4000) = NULL,
    @parameter_20 NVARCHAR(4000) = NULL,
    @parameter_21 NVARCHAR(4000) = NULL,
    @parameter_22 NVARCHAR(4000) = NULL,
    @parameter_23 NVARCHAR(4000) = NULL,
    @parameter_24 NVARCHAR(4000) = NULL,
    @parameter_25 NVARCHAR(4000) = NULL,
    @parameter_26 NVARCHAR(4000) = NULL,
    @parameter_27 NVARCHAR(4000) = NULL,
    @parameter_28 NVARCHAR(4000) = NULL,
    @parameter_29 NVARCHAR(4000) = NULL,
    @parameter_30 NVARCHAR(4000) = NULL,
    @parameter_31 NVARCHAR(4000) = NULL,
    @parameter_32 NVARCHAR(4000) = NULL,
    @parameter_33 NVARCHAR(4000) = NULL,
    @parameter_34 NVARCHAR(4000) = NULL,
    @parameter_35 NVARCHAR(4000) = NULL,
    @parameter_36 NVARCHAR(4000) = NULL,
    @parameter_37 NVARCHAR(4000) = NULL,
    @parameter_38 NVARCHAR(4000) = NULL,
    @parameter_39 NVARCHAR(4000) = NULL,
    @parameter_40 NVARCHAR(4000) = NULL,
    @parameter_41 NVARCHAR(4000) = NULL,
    @parameter_42 NVARCHAR(4000) = NULL,
    @parameter_43 NVARCHAR(4000) = NULL,
    @parameter_44 NVARCHAR(4000) = NULL,
    @parameter_45 NVARCHAR(4000) = NULL,
    @parameter_46 NVARCHAR(4000) = NULL,
    @parameter_47 NVARCHAR(4000) = NULL,
    @parameter_48 NVARCHAR(4000) = NULL,
    @parameter_49 NVARCHAR(4000) = NULL,
    @parameter_50 NVARCHAR(4000) = NULL
    
AS
BEGIN
    SET NOCOUNT ON;

	--/////////////////// Start OF CHECK PERMISSION NEVER TOUCH PLEASE ///////////--




	--/////////////////// END OF CHECK PERMISSION NEVER TOUCH PLEASE ///////////--

    BEGIN TRY
       DECLARE @tc int = @@TRANCOUNT;
       IF @tc = 0 BEGIN TRANSACTION; 


					---/////////////////////--Start BuildingType Page SP--////////////////////////--


        IF @pageName_ ='BuildingType'
        BEGIN
                -- عملية INSERT
           IF @ActionType = 'INSERT'
              BEGIN
				IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				--GetListUserPermission(@entrydata,@pageName_,@ActionType)
				Begin
                    EXEC [Housing].[BuildingTypeSP]
                        @Action =    @ActionType
					   ,@buildingTypeID				=null
					   ,@buildingTypeCode			=@parameter_01
					   ,@buildingTypeName_A 		=@parameter_02
					   ,@buildingTypeName_E 		=@parameter_03
					   ,@buildingTypeDescription 	=@parameter_04
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName

              END
				ELSE
			 BEGIN
        
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
		END
				

                -- عملية UPDATE
                ELSE IF @ActionType = 'UPDATE'
                BEGIN
				IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				Begin
                    EXEC [Housing].[BuildingTypeSP]
                       @Action =    @ActionType
					   ,@buildingTypeID				=@parameter_01
					   ,@buildingTypeCode			=@parameter_02
					   ,@buildingTypeName_A 		=@parameter_03
					   ,@buildingTypeName_E 		=@parameter_04
					   ,@buildingTypeDescription 	=@parameter_05
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName
                END
				
				ELSE
			 BEGIN
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
			 END


                -- عملية DELETE
                ELSE IF @ActionType = 'DELETE'
                BEGIN
            IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				Begin
                        EXEC [Housing].[BuildingTypeSP]
                        @Action =    @ActionType
					   ,@buildingTypeID				=@parameter_01
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName
                END

				ELSE
			 BEGIN
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
			 END

			 ----///////////////////////////////////// DOWN CODE IF ActionType Not Exist /////////////////////////////////////////---
                ELSE
                BEGIN
                   SELECT 0 As IsSuccessful,N'نوع العملية المطلوبة غير معروف. ActionType' AS Message_
                END
			----///////////////////////////////////// UP CODE IF ActionType Not Exist /////////////////////////////////////////---

      
    END
	


			---/////////////////////--END BuildingType Page SP--////////////////////////--




			
					---/////////////////////--Start BuildingClass Page SP--////////////////////////--


        ELSE IF @pageName_ ='BuildingClass'
        BEGIN
                -- عملية INSERT
           IF @ActionType = 'INSERT'
              BEGIN
				IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				--GetListUserPermission(@entrydata,@pageName_,@ActionType)
				Begin
                    EXEC [Housing].[BuildingClassSP]
                        @Action =    @ActionType
					   ,@BuildingClassName_A 		=@parameter_01
					   ,@BuildingClassName_E 		=@parameter_02
					   ,@BuildingClassDescription 	=@parameter_03
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName

              END
				ELSE
			 BEGIN
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
		END
				

                -- عملية UPDATE
                ELSE IF @ActionType = 'UPDATE'
                BEGIN
				IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				Begin
                    EXEC [Housing].[BuildingClassSP]
                       @Action =    @ActionType
					   ,@BuildingClassID				=@parameter_01
					   ,@BuildingClassName_A 		=@parameter_02
					   ,@BuildingClassName_E 		=@parameter_03
					   ,@BuildingClassDescription 	=@parameter_04
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName
                END
				
				ELSE
			 BEGIN
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
			 END


                -- عملية DELETE
                ELSE IF @ActionType = 'DELETE'
                BEGIN
            IF(select count(*) FROM DATACORE.dbo.V_GetListUserPermission v where v.userID = @entrydata AND v.menuName_E = @pageName_ AND v.permissionTypeName_E = @ActionType) > 0
				Begin
                        EXEC [Housing].[BuildingClassSP]
                        @Action =    @ActionType
					   ,@BuildingClassID				=@parameter_01
					   ,@BuildingClassName_A 		=@parameter_02
					   ,@BuildingClassName_E 		=@parameter_03
					   ,@BuildingClassDescription 	=@parameter_04
					   ,@entryData 					=@entrydata
					   ,@hostName 					=@hostName
                END

				ELSE
			 BEGIN
				SELECT 0 As IsSuccessful,N'عفوا لاتملك صلاحية لهذه العملية' AS Message_
		     END
			 END

			 ----///////////////////////////////////// DOWN CODE IF ActionType Not Exist /////////////////////////////////////////---
                ELSE
                BEGIN
                   SELECT 0 As IsSuccessful,N'نوع العملية المطلوبة غير معروف. ActionType' AS Message_
                END
			----///////////////////////////////////// UP CODE IF ActionType Not Exist /////////////////////////////////////////---

        
    END
	


			---/////////////////////--END BuildingClassSP Page SP--////////////////////////--










----/////////////////////////////////////NAVER TOUCH DOWN CODE PLEASE/////////////////////////////////////////---
   
    ELSE
    BEGIN
         SELECT 0 As IsSuccessful,N'الصفحة المرسلة مقيدة. PageName' AS Message_
    END


	 COMMIT TRANSACTION;
    END TRY

   BEGIN CATCH
    DECLARE @ErrMsg       NVARCHAR(4000) = ERROR_MESSAGE();
    DECLARE @ErrSeverity  INT           = ERROR_SEVERITY();
    DECLARE @ErrState     INT           = ERROR_STATE();
    DECLARE @IdCatch      INT = NULL;

    -- إذا كانت المعاملة غير قابلة للاعتماد: لازم ROLLBACK أولاً
    IF XACT_STATE() = -1
    BEGIN
        ROLLBACK TRANSACTION;                  -- فكّ المعاملة التالفة أولاً
        INSERT INTO DATACORE.dbo.ErrorLog
        (
            ERROR_MESSAGE_, ERROR_SEVERITY_, ERROR_STATE_,
            SP_NAME, entryData, hostName
        )
        VALUES
        (
            @ErrMsg, @ErrSeverity, @ErrState,
            N'[dbo].[Masters_CRUD]', @entrydata, @hostName
        );
        SET @IdCatch = SCOPE_IDENTITY();
    END
    ELSE IF XACT_STATE() = 1 AND @tc = 0
    BEGIN
        -- لازالت المعاملة صالحة لكننا سنرجع كل شيء
        ROLLBACK TRANSACTION;

        INSERT INTO DATACORE.dbo.ErrorLog
        (
            ERROR_MESSAGE_, ERROR_SEVERITY_, ERROR_STATE_,
            SP_NAME, entryData, hostName
        )
        VALUES
        (
            @ErrMsg, @ErrSeverity, @ErrState,
            N'[dbo].[Masters_CRUD]', @entrydata, @hostName
        );
        SET @IdCatch = SCOPE_IDENTITY();
    END
    ELSE
    BEGIN
        -- لا توجد معاملة نشطة
        INSERT INTO DATACORE.dbo.ErrorLog
        (
            ERROR_MESSAGE_, ERROR_SEVERITY_, ERROR_STATE_,
            SP_NAME, entryData, hostName
        )
        VALUES
        (
            @ErrMsg, @ErrSeverity, @ErrState,
            N'[dbo].[Masters_CRUD]', @entrydata, @hostName
        );
        SET @IdCatch = SCOPE_IDENTITY();
    END

    IF @IdCatch IS NOT NULL
        SELECT 0 AS IsSuccessful, N'حصل خطأ غير معروف رمز الخطأ : ' + CAST(@IdCatch AS NVARCHAR(200)) AS Message_;
    ELSE
        SELECT 0 AS IsSuccessful, N'حصل خطأ غير معروف رمز الخطأ : xxx' AS Message_;
END CATCH

END

----/////////////////////////////////////NAVER TOUCH UP CODE PLEASE/////////////////////////////////////////---

GO
/****** Object:  StoredProcedure [dbo].[Masters_DataLoad]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Masters_DataLoad]
    @pageName_ NVARCHAR(400),
	@idaraID INT,
	@entrydata int,
	@hostname NVARCHAR(400),
    @parameter_01 NVARCHAR(4000) = NULL,
    @parameter_02 NVARCHAR(4000) = NULL,
    @parameter_03 NVARCHAR(4000) = NULL,
    @parameter_04 NVARCHAR(4000) = NULL,
    @parameter_05 NVARCHAR(4000) = NULL,
    @parameter_06 NVARCHAR(4000) = NULL,
    @parameter_07 NVARCHAR(4000) = NULL,
    @parameter_08 NVARCHAR(4000) = NULL,
    @parameter_09 NVARCHAR(4000) = NULL,
    @parameter_10 NVARCHAR(4000) = NULL
   
    
AS
BEGIN
    SET NOCOUNT ON;

	--/////////////////// Start OF CHECK PERMISSION NEVER TOUCH PLEASE ///////////--




	--/////////////////// END OF CHECK PERMISSION NEVER TOUCH PLEASE ///////////--

    BEGIN TRY
        BEGIN TRANSACTION;


			---/////////////////////--Start BuildingType Page SP--////////////////////////--


        IF @pageName_ ='BuildingType'
        BEGIN

		---/////////////////////--Start User Permission Data--////////////////////////--
            select v.permissionTypeName_E 
			FROM DATACORE.dbo.V_GetListUserPermission v 
			where v.userID = @entrydata 
			AND v.menuName_E = @pageName_
		---/////////////////////--END User Permission Data--////////////////////////--



		---/////////////////////--Start BuildingType Data--////////////////////////--
            select t.buildingTypeID,t.buildingTypeCode,t.buildingTypeName_A,t.buildingTypeName_E,t.buildingTypeDescription 
			FROM DATACORE.Housing.BuildingType t
			where t.buildingTypeActive = 1 
			
		---/////////////////////--END BuildingType Data--////////////////////////--

		---/////////////////////--Start City DDL Data--////////////////////////--
            select c.cityID,c.cityName_A
			FROM DATACORE.dbo.City c
			where c.cityActive = 1 
			
		---/////////////////////--END City DDL Data--////////////////////////--
      
	    END
	


			---/////////////////////--END BuildingType Page SP--////////////////////////--




			
			---/////////////////////--Start BuildingClass Page SP--////////////////////////--


        ELSE IF @pageName_ ='BuildingClass'
        BEGIN
                ---/////////////////////--Start User Permission Data--////////////////////////--
             select v.permissionTypeName_E 
			FROM DATACORE.dbo.V_GetListUserPermission v 
			where v.userID = @entrydata 
			AND v.menuName_E = @pageName_
		       ---/////////////////////--END User Permission Data--////////////////////////--


		---/////////////////////--Start BuildingType Data--////////////////////////--
           
			select c.buildingClassID,c.buildingClassName_A,c.buildingClassName_E,c.buildingClassDescription,c.buildingClassOrder,c.buildingClassActive
			from DATACORE.Housing.BuildingClass c
			where c.buildingClassActive = 1
			
		---/////////////////////--END BuildingType Data--////////////////////////--

         
        END
	


			---/////////////////////--END BuildingClassSP Page SP--////////////////////////--










----/////////////////////////////////////NAVER TOUCH DOWN CODE PLEASE/////////////////////////////////////////---
   
    ELSE
    BEGIN
         SELECT 0 As IsSuccessful,N'الصفحة المرسلة مقيدة. PageName' AS Message_
    END


	 COMMIT TRANSACTION;
    END TRY

    BEGIN CATCH
        IF @@TRANCOUNT > 0
		BEGIN

		 DECLARE @ErrMsg NVARCHAR(4000), @ErrSeverity INT, @ErrState INT,@IdentityCatchError int
        --SELECT 
          set  @ErrMsg = ERROR_MESSAGE();
          set  @ErrSeverity = ERROR_SEVERITY();
          set  @ErrState = ERROR_STATE();

		  INSERT INTO DATACORE.dbo.ErrorLog
		  (ERROR_MESSAGE_,
		  ERROR_SEVERITY_,
		  ERROR_STATE_,
		  SP_NAME,
		  entryData,
		  hostName)
		  Values
		  (@ErrMsg,
		  @ErrSeverity,
		  @ErrState,
		  N'[dbo].[Masters_DataLoad]',
		  @entrydata,
		  @hostName
		  )

		  set @IdentityCatchError = SCOPE_IDENTITY()
		  if(@IdentityCatchError > 0)
		  Begin

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : '+CAST(@IdentityCatchError as nvarchar(200)) AS Message_

		  END
    ELSE
		  BEGIN

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : xxx'

		  END

            ROLLBACK TRANSACTION;

       END

        --RAISERROR(@ErrMsg, @ErrSeverity, @ErrState);
    END CATCH
END

----/////////////////////////////////////NAVER TOUCH UP CODE PLEASE/////////////////////////////////////////---

GO
/****** Object:  StoredProcedure [dbo].[SetUserPassword]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[SetUserPassword]
(
    @UserID          NVARCHAR(20),     -- الرقم العام / رقم المستخدم
    @PlainPassword   NVARCHAR(200),    -- كلمة المرور الجديدة
    @entryData       NVARCHAR(20),     -- المستخدم الذي قام بالتعديل
    @hostName        NVARCHAR(200) = NULL
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Salt       VARBINARY(32);
    DECLARE @Hash       VARBINARY(64);

    DECLARE @PrevSalt   VARBINARY(32);
    DECLARE @PrevHash   VARBINARY(64);
    DECLARE @Candidate  VARBINARY(64);

    BEGIN TRY

        ----------------------------------------------------
        -- 0) التحقق أن المستخدم موجود وفعال في جدول [User]
        ----------------------------------------------------
        IF NOT EXISTS (
            SELECT 1 
            FROM DATACORE.dbo.[User]
            WHERE IDNumber = @UserID
              AND userActive = 1
        )
        BEGIN
            SELECT 0 AS IsSuccessful,
                   N'المستخدم غير موجود أو غير فعّال في النظام.' AS Message_;
            RETURN;
        END


        ----------------------------------------------------
        -- 1) التحقق من تعقيد كلمة المرور الجديدة
        ----------------------------------------------------
        IF LEN(@PlainPassword) < 8
           OR @PlainPassword NOT LIKE '%[0-9]%'      -- لا تحتوي رقم
           OR @PlainPassword NOT LIKE '%[A-Za-z]%'   -- لا تحتوي حرف إنجليزي
        BEGIN
            SELECT 0 AS IsSuccessful,
                   N'كلمة المرور غير مقبولة. يجب أن لا تقل عن 8 خانات وتحتوي على حروف إنجليزية وأرقام.' AS Message_;
            RETURN;
        END


        ----------------------------------------------------
        -- 2) التأكد أن كلمة المرور الجديدة ليست نفسها القديمة
        ----------------------------------------------------
        SELECT TOP (1)
            @PrevSalt = PasswordSalt,
            @PrevHash = PasswordHash
        FROM dbo.userPassword
        WHERE IDNumber_FK = @UserID
          AND ISNULL(userPasswordActive, 1) = 1
        ORDER BY userPasswordStartDate DESC, userPasswordID DESC;

        IF @PrevHash IS NOT NULL
        BEGIN
            SET @Candidate = HASHBYTES(
                                'SHA2_256',
                                @PrevSalt + CAST(@PlainPassword AS VARBINARY(200))
                             );

            IF @Candidate = @PrevHash
            BEGIN
                SELECT 0 AS IsSuccessful,
                       N'لا يمكن استخدام نفس كلمة المرور السابقة. الرجاء اختيار كلمة مرور جديدة مختلفة.' AS Message_;
                RETURN;
            END
        END


        ----------------------------------------------------
        -- 3) البدء في المعاملة
        ----------------------------------------------------
        BEGIN TRANSACTION;

        -- تعطيل كل كلمات المرور السابقة
        UPDATE dbo.userPassword
        SET 
            userPasswordActive  = 0,
            userPasswordEndDate = CAST(GETDATE() AS DATE)
        WHERE IDNumber_FK = @UserID
          AND ISNULL(userPasswordActive, 1) = 1;


        ----------------------------------------------------
        -- 4) إنشاء Salt جديد + Hash جديد
        ----------------------------------------------------
        SET @Salt = CRYPT_GEN_RANDOM(32);

        SET @Hash = HASHBYTES(
                        'SHA2_256',
                        @Salt + CAST(@PlainPassword AS VARBINARY(200))
                    );


        ----------------------------------------------------
        -- 5) إدخال كلمة المرور الجديدة
        ----------------------------------------------------
        INSERT INTO dbo.userPassword
        (
            IDNumber_FK,
            PasswordHash,
            PasswordSalt,
            HashAlgorithm,
            userPasswordStartDate,
            userPasswordActive,
            entryDate,
            entryData,
            hostName
        )
        VALUES
        (
            @UserID,
            @Hash,
            @Salt,
            'SHA2_256',
            CAST(GETDATE() AS DATE),
            1,
            GETDATE(),
            @entryData,
            ISNULL(@hostName, HOST_NAME())
        );

        COMMIT TRANSACTION;

        SELECT 1 AS IsSuccessful,
               N'تم تحديث كلمة المرور / إنشاؤها بنجاح.' AS Message_;


    END TRY
    BEGIN CATCH

        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;

        SELECT 0 AS IsSuccessful,
               N'حصل خطأ أثناء تنفيذ العملية: ' + ERROR_MESSAGE() AS Message_;
    END CATCH
END
GO
/****** Object:  StoredProcedure [Housing].[BuildingClassSP]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [Housing].[BuildingClassSP] ( @Action NVARCHAR(200)   
										  ,@buildingClassID bigint					   =   NULL
										  ,@buildingClassName_A nvarchar(100)		   =   NULL
										  ,@buildingClassName_E nvarchar(100)		   =   NULL
										  ,@buildingClassDescription nvarchar(1000)	   =   NULL
										  ,@entryData nvarchar(20)					   =   NULL
										  ,@hostName nvarchar(200)				       =  NULL
										  )
AS
BEGIN
	SET NOCOUNT ON; 
    DECLARE @ErrorMessage NVARCHAR(4000)
	, @NewID        INT
	, @Note         NVARCHAR(MAX)
	, @Identity_Insert NVARCHAR(500)
	, @Identity_Update NVARCHAR(500)
	, @Identity_Delete NVARCHAR(500);
	BEGIN TRY
	BEGIN TRANSACTION;
	IF @Action = 'INSERT'


	BEGIN
		
		
			IF ( select count (*) from DATACORE.Housing.BuildingClass c where c.buildingClassName_A= @buildingClassName_A  ) > 0 
		    BEGIN
				
				SELECT 0 As IsSuccessful,N'البيانات مدخلة مسبقا' AS Message_
			 END 
		ELSE
			 BEGIN

	INSERT INTO DATACORE.[Housing].BuildingClass
           ([buildingClassName_A]
           ,[buildingClassName_E]
           ,[buildingClassDescription]
           ,[buildingClassActive]
           ,[entryData]
           ,[hostName])
     VALUES
           (@buildingClassName_A 
           ,@buildingClassName_E 
           ,@buildingClassDescription 
           ,1 
           ,@entryData 
           ,@hostName )


           
     

        SET @NewID = SCOPE_IDENTITY(); 
        SET @Note = '{' + '"buildingClassName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingClassName_A), '') + '"' 
		+ ',' + '"buildingClassName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingClassName_E), '') + '"' + ',' + '"buildingClassDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingClassDescription), '') + '"' 
		+ ',' + '"buildingClassActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
		+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 


		SET @Identity_Insert = SCOPE_IDENTITY(); 
		IF(@Identity_Insert > 0)
		Begin
		        INSERT INTO DATACORE.dbo.AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
		VALUES                ( '[Housing].[BuildingClass]', 'INSERT',   @NewID,   @entryData, @Note ); 
        COMMIT;
		SELECT 1 As IsSuccessful,N'تم اضافة البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في اضافة البيانات ' AS Message_
		END


	END 
	END


    ELSE IF @Action = 'UPDATE'
		BEGIN
			IF EXISTS (SELECT 1
				FROM DATACORE.[Housing].[BuildingClass]
				WHERE BuildingClassID = @BuildingClassID)
			BEGIN
				UPDATE DATACORE.[Housing].[BuildingClass]
				SET  [BuildingClassName_A]	  =ISNULL(@BuildingClassName_A, [BuildingClassName_A])
				,   [BuildingClassName_E]	  =ISNULL(@BuildingClassName_E, [BuildingClassName_E])
				,   [BuildingClassDescription] =ISNULL(@BuildingClassDescription, [BuildingClassActive])
				,   [BuildingClassActive]	  =ISNULL(1, [BuildingClassActive])
				,   [entryData]			      =ISNULL(@entryData, [entryData])
				,   [hostName]			      =ISNULL(@entryData,  [hostName])
				WHERE [BuildingClassID] = @BuildingClassID; 

				
				 SET @Note = '{' + '"BuildingClassName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassName_A), '') + '"' 
							+ ',' + '"BuildingClassName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassName_E), '') + '"' + ',' + '"BuildingClassDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassDescription), '') + '"' 
							+ ',' + '"BuildingClassActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
							+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 




							SET @Identity_Update = @@ROWCOUNT; 
		IF(@Identity_Update > 0)
		Begin
		         INSERT INTO AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
					VALUES                ( '[Housing].[BuildingClass]', 'UPDATE',   @NewID,   @entryData, @Note ); 
				COMMIT;
				SELECT 1 As IsSuccessful,N'تم تحديث البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في تحديث البيانات ' AS Message_
		END



				
			END 
			ELSE 
			SELECT 0 As IsSuccessful,N'حصل خطأ في تحديث البيانات x' AS Message_


		END 

		 ELSE IF @Action = 'DELETE'
		BEGIN
			IF EXISTS (SELECT 1
				FROM DATACORE.[Housing].[BuildingClass]
				WHERE BuildingClassID = @BuildingClassID)
			BEGIN
				UPDATE DATACORE.[Housing].[BuildingClass]
				SET [BuildingClassActive]		  = 0
				WHERE [BuildingClassID] = @BuildingClassID; 

				 SET @Note = '{' + '"BuildingClassName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassName_A), '') + '"' 
							+ ',' + '"BuildingClassName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassName_E), '') + '"' + ',' + '"BuildingClassDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @BuildingClassDescription), '') + '"' 
							+ ',' + '"BuildingClassActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
							+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 


							
							SET @Identity_Update = @@ROWCOUNT; 
		IF(@Identity_Update > 0)
		Begin
		         INSERT INTO AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
					VALUES                ( '[Housing].[BuildingClass]', 'UPDATE',   @NewID,   @entryData, @Note ); 
				COMMIT;
				SELECT 1 As IsSuccessful,N'تم حذف البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في حذف البيانات ' AS Message_
		END



				
			END 
			ELSE 
			SELECT 0 As IsSuccessful,N'حصل خطأ في حذف البيانات x' AS Message_


		END 

	 
	ELSE 
	SELECT 0 As IsSuccessful,N'العملية غير مسجلة' AS Message_
		
	END TRY
	BEGIN CATCH
	IF @@TRANCOUNT > 0

		 DECLARE @ErrMsg NVARCHAR(4000), @ErrSeverity INT, @ErrState INT,@IdentityCatchError int
        --SELECT 
          set  @ErrMsg = cast(ERROR_MESSAGE() as nvarchar(4000));
          set  @ErrSeverity = cast(ERROR_SEVERITY()as nvarchar(4000));
          set  @ErrState = cast(ERROR_STATE()as nvarchar(4000));

		  INSERT INTO DATACORE.dbo.ErrorLog
		  (ERROR_MESSAGE_,
		  ERROR_SEVERITY_,
		  ERROR_STATE_,
		  SP_NAME,
		  entryData,
		  hostName)
		  Values
		  (@ErrMsg,
		  @ErrSeverity,
		  @ErrState,
		  N'[Housing].[BuildingClassSP]',
		  @entrydata,
		  @hostName
		  )

		  set @IdentityCatchError = SCOPE_IDENTITY()
		  if(@IdentityCatchError > 0)
		  Begin

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : '+CAST(@IdentityCatchError as nvarchar(200)) AS Message_

		  END
    ELSE
		  BEGIN

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : xxx'

		  END


		ROLLBACK;
	--SET @ErrorMessage = ERROR_MESSAGE();
	--RAISERROR(@ErrorMessage, 16, 1);
	END CATCH
END;
GO
/****** Object:  StoredProcedure [Housing].[BuildingTypeSP]    Script Date: 30/11/2025 12:49:07 ص ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Housing].[BuildingTypeSP] ( @Action NVARCHAR(200)   
										  ,@buildingTypeID bigint					   =   NULL
                                          ,@buildingTypeCode nvarchar(10)              =   NULL
										  ,@buildingTypeName_A nvarchar(100)		   =   NULL
										  ,@buildingTypeName_E nvarchar(100)		   =   NULL
										  ,@buildingTypeDescription nvarchar(1000)	   =   NULL
										  ,@entryData nvarchar(20)					   =   NULL
										  ,@hostName nvarchar(200)				       =  NULL
										  )
AS
BEGIN
	SET NOCOUNT ON; 
    DECLARE @ErrorMessage NVARCHAR(4000)
	, @NewID        INT
	, @Note         NVARCHAR(MAX)
	, @Identity_Insert NVARCHAR(500)
	, @Identity_Update NVARCHAR(500)
	, @Identity_Delete NVARCHAR(500);
	BEGIN TRY
	BEGIN TRANSACTION;
	IF @Action = 'INSERT'


	BEGIN
		
		
			IF ( select count (*) from DATACORE.Housing.BuildingType bt where bt.buildingTypeName_A= @buildingTypeName_A  ) > 0 
		    BEGIN
				
				SELECT 0 As IsSuccessful,N'البيانات مدخلة مسبقا' AS Message_
			 END 
		ELSE
			 BEGIN

	INSERT INTO DATACORE.[Housing].[BuildingType]
           ([buildingTypeCode]
           ,[buildingTypeName_A]
           ,[buildingTypeName_E]
           ,[buildingTypeDescription]
           ,[buildingTypeActive]
           ,[entryData]
           ,[hostName])
     VALUES
           (@buildingTypeCode 
           ,@buildingTypeName_A 
           ,@buildingTypeName_E 
           ,@buildingTypeDescription 
           ,1 
           ,@entryData 
           ,@hostName )


           
     

        SET @NewID = SCOPE_IDENTITY(); 
        SET @Note = '{' + '"buildingTypeCode": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeCode), '') + '"' + ',' + '"buildingTypeName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_A), '') + '"' 
		+ ',' + '"buildingTypeName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_E), '') + '"' + ',' + '"buildingTypeDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeDescription), '') + '"' 
		+ ',' + '"buildingTypeActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
		+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 


		SET @Identity_Insert = SCOPE_IDENTITY(); 
		IF(@Identity_Insert > 0)
		Begin
		        INSERT INTO DATACORE.dbo.AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
		VALUES                ( '[Housing].[BuildingType]', 'INSERT',   @NewID,   @entryData, @Note ); 
        COMMIT;
		SELECT 1 As IsSuccessful,N'تم اضافة البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في اضافة البيانات ' AS Message_
		END


	END 
	END


    ELSE IF @Action = 'UPDATE'
		BEGIN
			IF EXISTS (SELECT 1
				FROM DATACORE.[Housing].[BuildingType]
				WHERE buildingTypeID = @buildingTypeID)
			BEGIN
				UPDATE DATACORE.[Housing].[BuildingType]
				SET [buildingTypeCode]		  =ISNULL(@buildingTypeCode, [buildingTypeCode])
				,   [buildingTypeName_A]	  =ISNULL(@buildingTypeName_A, [buildingTypeName_A])
				,   [buildingTypeName_E]	  =ISNULL(@buildingTypeName_E, [buildingTypeName_E])
				,   [buildingTypeDescription] =ISNULL(@buildingTypeDescription, [buildingTypeActive])
				,   [buildingTypeActive]	  =ISNULL(1, [buildingTypeActive])
				,   [entryData]			      =ISNULL(@entryData, [entryData])
				,   [hostName]			      =ISNULL(@entryData,  [hostName])
				WHERE [buildingTypeID] = @buildingTypeID; 

				
				 SET @Note = '{' + '"buildingTypeCode": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeCode), '') + '"' + ',' + '"buildingTypeName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_A), '') + '"' 
							+ ',' + '"buildingTypeName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_E), '') + '"' + ',' + '"buildingTypeDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeDescription), '') + '"' 
							+ ',' + '"buildingTypeActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
							+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 




							SET @Identity_Update = @@ROWCOUNT; 
		IF(@Identity_Update > 0)
		Begin
		         INSERT INTO AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
					VALUES                ( '[Housing].[BuildingType]', 'UPDATE',   @NewID,   @entryData, @Note ); 
				COMMIT;
				SELECT 1 As IsSuccessful,N'تم تحديث البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في تحديث البيانات ' AS Message_
		END



				
			END 
			ELSE 
			SELECT 0 As IsSuccessful,N'حصل خطأ في تحديث البيانات x' AS Message_


		END 

		 ELSE IF @Action = 'DELETE'
		BEGIN
			IF EXISTS (SELECT 1
				FROM DATACORE.[Housing].[BuildingType]
				WHERE buildingTypeID = @buildingTypeID)
			BEGIN
				UPDATE DATACORE.[Housing].[BuildingType]
				SET [buildingTypeActive]		  = 0
				WHERE [buildingTypeID] = @buildingTypeID; 

				 SET @Note = '{' + '"buildingTypeCode": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeCode), '') + '"' + ',' + '"buildingTypeName_A": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_A), '') + '"' 
							+ ',' + '"buildingTypeName_E": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeName_E), '') + '"' + ',' + '"buildingTypeDescription": "' + ISNULL(CONVERT(NVARCHAR(MAX), @buildingTypeDescription), '') + '"' 
							+ ',' + '"buildingTypeActive": "' + ISNULL(CONVERT(NVARCHAR(MAX), 1), '') + '"' + ',' + '"entryData": "' + ISNULL(CONVERT(NVARCHAR(MAX), @entryData), '') + '"'
							+ ',' + '"hostName": "' + ISNULL(CONVERT(NVARCHAR(MAX), @hostName), '') + '"' + '}'; 


							
							SET @Identity_Update = @@ROWCOUNT; 
		IF(@Identity_Update > 0)
		Begin
		         INSERT INTO AuditLog ( TableName,            ActionType, RecordID, PerformedBy,  Notes )
					VALUES                ( '[Housing].[BuildingType]', 'UPDATE',   @NewID,   @entryData, @Note ); 
				COMMIT;
				SELECT 1 As IsSuccessful,N'تم حذف البيانات بنجاح' AS Message_
		END
	ELSE
	    Begin
		       
        RollBAck;
		SELECT 0 As IsSuccessful,N'حصل خطأ في حذف البيانات ' AS Message_
		END



				
			END 
			ELSE 
			SELECT 0 As IsSuccessful,N'حصل خطأ في حذف البيانات x' AS Message_


		END 

	 
	ELSE 
	SELECT 0 As IsSuccessful,N'العملية غير مسجلة' AS Message_
		
	END TRY
	BEGIN CATCH
	IF @@TRANCOUNT > 0

		 DECLARE @ErrMsg NVARCHAR(4000), @ErrSeverity INT, @ErrState INT,@IdentityCatchError int
        --SELECT 
          set  @ErrMsg = cast(ERROR_MESSAGE() as nvarchar(4000));
          set  @ErrSeverity = cast(ERROR_SEVERITY()as nvarchar(4000));
          set  @ErrState = cast(ERROR_STATE()as nvarchar(4000));

		  INSERT INTO DATACORE.dbo.ErrorLog
		  (ERROR_MESSAGE_,
		  ERROR_SEVERITY_,
		  ERROR_STATE_,
		  SP_NAME,
		  entryData,
		  hostName)
		  Values
		  (@ErrMsg,
		  @ErrSeverity,
		  @ErrState,
		  N'[Housing].[BuildingTypeSP]',
		  @entrydata,
		  @hostName
		  )

		  set @IdentityCatchError = SCOPE_IDENTITY()
		  if(@IdentityCatchError > 0)
		  Begin

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : '+CAST(@IdentityCatchError as nvarchar(200)) AS Message_

		  END
    ELSE
		  BEGIN

		   SELECT 0 As IsSuccessful,N'حصل خطأ غير معروف رمز الخطأ : xxx'

		  END


		ROLLBACK;
	--SET @ErrorMessage = ERROR_MESSAGE();
	--RAISERROR(@ErrorMessage, 16, 1);
	END CATCH
END;
GO
