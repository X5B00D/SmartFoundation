@using SmartFoundation.UI.ViewModels.SmartDatePicker
@model SmartFoundation.UI.ViewModels.SmartDatePicker.DatepickerViewModel

@{
    // Handle null Model safely
    var modelId = Model?.Id ?? "datepicker_" + Guid.NewGuid().ToString("N").Substring(0, 8);
    var modelName = Model?.Name ?? modelId;
    
    // Set default values for null Model properties
    var label = Model?.Label ?? string.Empty;
    var col = Model?.Col ?? "12";
    var value = Model?.Value ?? string.Empty;
    var placeholder = string.IsNullOrEmpty(Model?.PlaceHolder ?? string.Empty) ? "MM/DD/YYYY" : (Model?.PlaceHolder ?? "MM/DD/YYYY");
    var isReadOnly = Model?.IsReadOnly ?? false;
    var showTodayButton = Model?.ShowTodayButton ?? true;
    var format = Model?.Format ?? "mm/dd/yyyy";
    var orientation = Model?.Orientation ?? "auto";
    var hijri = Model?.Hijri ?? false;
    var showDay = Model?.ShowDay ?? false;
    var todayHighlight = Model?.TodayHighlight ?? true;
    var showClearButton = Model?.ShowClearButton ?? false;
    var helpText = Model?.HelpText ?? string.Empty;
}

<div class="form-group col-xl-@col">

    @if (!string.IsNullOrEmpty(label))
    {
        <label class="form-label fw-700" for="@modelId">@label</label>
    }
    <div class="input-group date rtl" id="@(modelId)_container">
        <input 
        type="text"
         id="@modelId" 
         name="@modelName"
         class="form-control" @(isReadOnly ? "readonly" : "") 
         placeholder="@placeholder" 
         aria-label="date"
         aria-describedby="@modelId"
         value="@value" />
        <div class="input-group-append">
            <span class="input-group-text fs-xl datepicker-toggle-btn">
                <i class="fal fa-calendar-alt"></i>
            </span>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(helpText))
    {
        <small class="form-text text-muted">@helpText</small>
    }

</div>
@* New Hijri date input *@
@if (hijri)
{
<div class="form-group col-xl-@col">
    <label class="control-label fw-700">هجري:</label>
    <div class="input-group date"  id="HijriDate_container">
        <div class="input-group-append">
            <span class="input-group-text fs-xl">
                <i class="fal fa-calendar-check"></i>
            </span>
        </div>
        <input id="HijriDate_@modelId" type="text" readonly class="form-control" />
    </div>
</div>
}

@* show exact day date  *@
@if (showDay)
{
 <div class="form-group col-xl-@col">
    <label class=" control-label fw-700">
        اليوم :
    </label>
    <div class="input-group date">
        <div class="input-group-append">
            <span class="input-group-text fs-xl">
                <i class="fal fa-calendar-check"></i>
            </span>
        </div>
        <input id="startDay_@modelId" type="text" readonly class="form-control">
    </div>
</div>
}

<!-- Stylesheets -->
 
<!-- Scripts --> 


<script>
    $(document).ready(function() { 
        var modelId = '@modelId';
        
        // Debug available locales
        //console.log("Available datepicker locales:", Object.keys($.fn.datepicker.dates || {}));
        //console.log(Object.keys($.fn.datepicker.dates));
        
        function initializeDatepicker() {
            // Create configuration object with default Arabic settings
            var config = {
                todayHighlight: @(todayHighlight.ToString().ToLower()),
                format: '@format',
                orientation: '@orientation',
                autoclose: true,
                zIndexOffset: 1000,
                language: 'ar-sa',
                rtl: true, 
                weekStart: 0, // Start with Saturday (6 in bootstrap-datepicker) 
                container: '#' + modelId + '_container'
            };

            //console.log('Datepicker config for ' + modelId + ':', config);
           // console.log('Datepicker format:', '@format');

            // Add optional properties
            @if(showTodayButton)
            {
                <text>config.todayBtn = 'linked';</text>
            }
            
            @if(showClearButton)
            {
                <text>config.clearBtn = true;</text>
            }
            
            // Initialize the datepicker
             var $dp = $('#' + modelId).datepicker(config);
            setTimeout(function() { $dp.datepicker('update'); }, 100);

            $dp.on('changeDate', function(e) {
                console.log('changeDate event fired for: ' + modelId, e.date);
                if (e.date) {
                    updateHijri(e.date);
                    updateDay(e.date);
                }
            });

            // Get the current date value (either from model or today)
            var currentDate = new Date();
            var inputValue = $('#' + modelId).val();
            
            //console.log('Initial input value for ' + modelId + ':', inputValue);
            
            if (inputValue) {
                // If there's a value in the input, try to parse it
                var parsedDate = $dp.datepicker('getDate');
                if (parsedDate) {
                    currentDate = parsedDate;
                    //console.log('Parsed date for ' + modelId + ':', currentDate);
                }
            }
            
            // Update the datepicker and trigger the day update
            $dp.datepicker('update', currentDate);
            updateHijri(currentDate);
            updateDay(currentDate);
            
            //console.log('Final datepicker value for ' + modelId + ':', $('#' + modelId).val());
            console.log('Datepicker initialized for:', modelId);
        }

        function updateHijri(jsDate) {
            console.log('updateHijri called with date:', jsDate);
            
            if (!jsDate) {
                console.warn('No date provided to updateHijri');
                return;
            }
            
            if (typeof moment === 'undefined') {
                console.error('moment.js not available for Hijri conversion');
                return;
            }
            
            try {
                var m = moment(jsDate);
                var hijriDate = m.format('iYYYY-iMM-iDD');
                console.log('Hijri conversion result:', hijriDate);
                
                $('#HijriDate_' + modelId).val(hijriDate);
            } catch (error) {
                console.error('Error converting to Hijri:', error);
            }
        }

        function updateDay(jsDate) {
            console.log('updateDay called with date:', jsDate);
            
            if (!jsDate) {
                console.warn('No date provided to updateDay');
                return;
            }
            
            if (typeof moment === 'undefined') {
                console.error('moment.js not available for day name');
                return;
            }
            
            try {
                // Use moment-with-locales.js for Arabic day name
                var m = moment(jsDate).locale('ar-sa');
                var dayName = m.format('dddd');
                console.log('Day name result:', dayName);
                
                $('#startDay_' + modelId).val(dayName);
            } catch (error) {
                console.error('Error getting day name:', error);
            }
        }

        function updateDayMin(jsDate) {
            if (!jsDate || typeof moment === 'undefined') return;
            
            var m = moment(jsDate).locale('ar-sa');
            var dayIndex = jsDate.getDay(); // 0=Sunday, ..., 6=Saturday
            var arabicDayMin = m.localeData().weekdaysMin(dayIndex);
            $('#shortDay_' + modelId).val(arabicDayMin);
        }

        initializeDatepicker();
    });
</script>