@model SmartFoundation.UI.ViewModels.SmartCharts.ChartCardConfig
@using SmartFoundation.UI.ViewModels.SmartCharts
@using System.Text.Json
@using System.Text.Encodings.Web

@{
    var hostId = $"healthkpiannual_{Model.Id}";
    var cfgId = $"{hostId}_cfg";

    //  مصدر البيانات الجديد: HealthKpiIndicators
    var indicators = (Model.HealthKpiIndicators ?? new List<HealthKpiIndicator>())
        .Where(x => !string.IsNullOrWhiteSpace(x.Key))
        .Select(k => new
        {
            key = k.Key,
            title = k.Title ?? "",
            subtitle = k.Subtitle ?? "",
            unit = k.Unit ?? "",
            icon = k.Icon ?? "",
            emoji = k.Emoji ?? "",
            tone = (k.Tone ?? "info").ToLower(),
            planGoal = k.PlanGoal, // nullable
            hint = k.Hint ?? "",
            href = k.Href ?? "",
            years = (k.Years ?? new List<HealthKpiIndicatorYear>())
                .OrderBy(y => y.Year)
                .Select(y => new
                {
                    key = y.Key ?? "",
                    year = y.Year,
                    title = y.Title ?? "",
                    subtitle = y.Subtitle ?? "",
                    target = y.Target,   // nullable
                    actual = y.Actual,   // nullable
                    badge = y.Badge ?? "",
                    tone = (y.Tone ?? "info").ToLower(),
                    icon = y.Icon ?? "",
                    emoji = y.Emoji ?? "",
                    href = y.Href ?? ""
                })
        }).ToList();

    var cfg = new
    {
        id = hostId,
        dir = (Model.Dir ?? "rtl").ToLower(),
        animate = Model.HealthKpiAnimate,
        valueFormat = "0",
        indicators = indicators
    };

    var json = JsonSerializer.Serialize(cfg, new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.Default,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    });

    // ✅ عنوان/وصف البانل من نفس ChartCardConfig
    var title = Model.Title ?? "مؤشر أداء المدن الصحية";
    var subtitle = Model.Subtitle ?? "خطة مستهدفات الفعاليات والمشاركات الإجتماعية للمدن الصحية (2026 - 2028)";
}

<div class="hkpa-panel" dir="@Model.Dir">
    <!-- ✅ Panel Header (لهذا الشارت فقط) -->
    <div class="hkpa-panel__head">
        <div class="hkpa-panel__title">
            <span class="hkpa-panel__heart" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
                    <path fill="currentColor"
                          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
         2 5.42 4.42 3 7.5 3
         9.24 3 10.91 3.81 12 5.09
         13.09 3.81 14.76 3 16.5 3
         19.58 3 22 5.42 22 8.5
         22 12.28 18.6 15.36 13.45 20.04
         L12 21.35z" />
                </svg>
            </span>

            <span>@title</span>
        </div>

        @if (!string.IsNullOrWhiteSpace(subtitle))
        {
            <div class="hkpa-panel__sub">@subtitle</div>
        }
    </div>

    <!-- ✅ Chart Body -->
    <div id="@hostId"
         class="smart-healthkpiannual"
         dir="@Model.Dir"
         data-config-id="@cfgId"
         data-top-tip="full">
        <!-- ✅ data-top-tip="full"
             إشارة للـ JS: Tooltip للمربعات العلوية لازم يعرض كل التفاصيل (سنوات/منجز/مستهدف/متبقي/عناوين) -->
        <!-- Toolbar -->
        <div class="hkpa-toolbar" aria-label="خيارات العرض">
            <button type="button" class="hkpa-viewbtn is-on" data-view="matrix">عرض مختصر</button>
            <button type="button" class="hkpa-viewbtn" data-view="detail">عرض مفصل</button>
        </div>

        <!-- Row 1: 7 indicators injected by JS -->
        <div class="hkpa-top" aria-label="مؤشرات الأداء العامة">
            <div class="hkpa-indicators"></div>
        </div>

        <!-- Compact Matrix -->
        <div class="hkpa-matrix" aria-label="مصفوفة المؤشرات حسب السنوات"></div>

        <!-- ✅ Detailed (مرة واحدة فقط) -->
        <div class="hkpa-years" aria-label="الأداء السنوي حسب السنة"></div>

        <!-- Tooltip portal -->
        <div class="hkpa-tip" aria-hidden="true">
            <div class="hkpa-tip__title"></div>
            <div class="hkpa-tip__body"></div>
        </div>
    </div>

    <script type="application/json" id="@cfgId">
        @Html.Raw(json)
    </script>
</div>
