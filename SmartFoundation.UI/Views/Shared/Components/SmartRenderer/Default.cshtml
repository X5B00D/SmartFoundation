@model SmartFoundation.UI.ViewModels.SmartPage.SmartPageViewModel

@{
    var hasPanelContent =
        Model.Form is not null
        || Model.DatePicker is not null
        || Model.TableDS is not null
        || Model.TableDS1 is not null
        || Model.TableDS2 is not null
        || Model.TableDS3 is not null
        || Model.TableDS4 is not null
        || Model.TableDS5 is not null
        || Model.Table is not null;
}

@if (Model.Charts is not null)
{
    <div class="w-full">
        <div class="bg-white rounded-sm border border-gray-100 shadow-sm p-6">
            @await Component.InvokeAsync("SmartCharts", new { model = Model.Charts, embedded = true })
        </div>
    </div>
}

@if (hasPanelContent)
{
    <div x-data="{ open:true }" class="sf-panel mt-6">
        <div class="sf-panel-header">
            <h3 class="sf-panel-title flex items-center gap-2">
                <i class="fa-solid @(Model.PanelIcon ?? "fa-layer-group") text-emerald-600 text-sm"></i>
                @(Model.PanelTitle ?? Model.PageTitle)
            </h3>

            <div class="sf-panel-actions">
                <button type="button" x-on:click="open = !open" class="sf-panel-btn" title="تصغير/توسيع">
                    <i class="fa-solid" x-bind:class="open ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </button>

                <button type="button"
                        x-on:click="$el.closest('.sf-panel').remove()"
                        class="sf-panel-btn sf-panel-btn-close"
                        title="إغلاق">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="sf-panel-body" x-show="open">
            @if (Model.Form is not null)
            {
                @await Component.InvokeAsync("SmartForm", new { model = Model.Form, embedded = true })
            }

            @if (Model.DatePicker is not null)
            {
                @await Component.InvokeAsync("SmartDatePicker", new { model = Model.DatePicker, embedded = true })
            }

            @if (Model.TableDS is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS, embedded = true })
            }
            @if (Model.TableDS1 is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS1, embedded = true })
            }
            @if (Model.TableDS2 is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS2, embedded = true })
            }
            @if (Model.TableDS3 is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS3, embedded = true })
            }
            @if (Model.TableDS4 is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS4, embedded = true })
            }
            @if (Model.TableDS5 is not null)
            {
                @await Component.InvokeAsync("SmartTableDS", new { model = Model.TableDS5, embedded = true })
            }

            
            @if (Model.Table is not null)
            {
                @await Component.InvokeAsync("SmartTable", new { model = Model.Table, embedded = true })
            }
        </div>
    </div>
}

@* ===== Global Print Iframe (ONE TIME) ===== *@
<iframe id="sf-print-frame"
        style="display:none;width:0;height:0;border:0"></iframe>

<script>
    // prevent re-define if SmartRenderer rendered multiple times
    window.sfOpenPrint = window.sfOpenPrint || function (url) {

        const frame = document.getElementById('sf-print-frame');
        if (!frame) {
            console.error('sf-print-frame not found');
            return;
        }

        // add a cache buster to force reload even if same url
        try {
            const u = new URL(url, window.location.origin);
            u.searchParams.set('_t', Date.now().toString());
            url = u.toString();
        } catch { /* ignore */ }

        frame.onload = function () {
            try {
                frame.contentWindow.focus();
                frame.contentWindow.print();
            } catch (e) {
                console.error('Print failed:', e);
            }
        };

        frame.src = url;
    };
</script>


