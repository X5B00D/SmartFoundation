@using System.Text.Json
@using System.Text.Json.Serialization
@using SmartFoundation.UI.ViewModels.SmartTable
@using SmartFoundation.UI.ViewModels.SmartForm
@model SmartTableDsModel

@{
    // ✅ 1) هذا أهم سطرين: يخلي Enum (Placement) يطلع كنص "ActionsMenu" بدل رقم 1
    var webJson = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    webJson.Converters.Add(new JsonStringEnumConverter());

    var tableConfig = new
    {
        clientSideMode = true,
        endpoint = "/smart/execute",
        spName = Model.StoredProcedureName,           // لو تحتاجه في js
        operation = Model.Operation,                  // لو تحتاجه في js

        pageSize = Model.PageSize,
        pageSizes = Model.PageSizes,
        searchable = Model.Searchable,
        searchPlaceholder = Model.SearchPlaceholder ?? "بحث…",
        quickSearchFields = Model.QuickSearchFields ?? new List<string>(),

        allowExport = Model.AllowExport,
        showHeader = Model.ShowHeader,
        showFooter = Model.ShowFooter,
        autoRefresh = true,

        columns = Model.Columns ?? new List<TableColumn>(),
        actions = new List<object>(),

        selectable = Model.Selectable,
        singleSelect = true,
        rowIdField = Model.RowIdField ?? "Id",
        rows = Model.Rows ?? new List<Dictionary<string, object?>>(),

        toolbar = Model.Toolbar ?? new TableToolbarConfig(),
        styleRules = Model.StyleRules ?? new List<TableStyleRule>(),

        tabelLabel = Model.TabelLabel ?? "",
        showToolbar = Model.ShowToolbar,
        enableCellCopy = Model.EnableCellCopy,
    };
}

<div x-data='sfTable(@Html.Raw(JsonSerializer.Serialize(tableConfig, webJson)))'
     x-init="init()"
     x-cloak
     x-on:refresh-table.window="refresh()">

    @* ================= LABEL ================= *@
    @if (!string.IsNullOrWhiteSpace(Model.TabelLabel))
    {
        <div class="my-6 rounded-sm border border-gray-300 bg-sky-50 px-4 py-3 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="h-px flex-1 bg-sky-200/60"></div>
                <div class="flex items-center gap-2 text-lg font-semibold whitespace-nowrap text-green-700">
                    @if (!string.IsNullOrWhiteSpace(Model.TabelLabelIcon))
                    {
                        <i class="@Model.TabelLabelIcon text-green-700"></i>
                    }
                    <span>@Model.TabelLabel</span>
                </div>
                <div class="h-px flex-1 bg-sky-200/60"></div>
            </div>
        </div>
    }

    @* ================= TOOLBAR ================= *@
    @if (Model.ShowToolbar)
    {
        <div class="toolbar">

            @* البحث فقط يتبع searchable *@
            <div class="toolbar-search" x-show="searchable">
                <input type="text"
                       class="sf-input search-input"
                       x-model="q"
                       x-on:input.debounce.500="debouncedSearch()"
                       :placeholder="searchPlaceholder" />

                <button type="button"
                        class="btn btn-secondary"
                        x-on:click="refresh()"
                        x-show="toolbar.showRefresh">
                    <i class="fa fa-rotate"></i>
                    <span class="hidden-md">تحديث</span>
                </button>
            </div>

            @* ✅ 2) لا تربط أزرار التولبار بـ searchable (عشان ما تختفي) *@
            <div class="toolbar-actions">

                <label class="label-sm">صف/صفحة</label>
                <select class="sf-input select-sm"
                        x-model.number="pageSize"
                        x-on:change="page=1; load()">
                    <template x-for="s in pageSizes" :key="s">
                        <option x-text="s"></option>
                    </template>
                </select>

                @* ===== تصدير ===== *@
                <!-- Excel -->
                <template x-if="allowExport && toolbar.showExportExcel">
                    <button type="button" class="btn btn-info" x-on:click="exportData('excel')">
                        <i class="fa fa-file-excel"></i> Excel
                    </button>
                </template>

                <!-- CSV -->
                <template x-if="allowExport && toolbar.showExportCsv">
                    <button type="button" class="btn btn-warning" x-on:click="exportData('csv')">
                        <i class="fa fa-file-csv"></i> CSV
                    </button>
                </template>

                <!-- PDF -->
                <template x-if="allowExport && toolbar.showExportPdf">
                    <button type="button" class="btn btn-danger" x-on:click="exportData('pdf')">
                        <i class="fa fa-file-pdf"></i> PDF
                    </button>
                </template>



                @* ===== أزرار مباشرة: Placement غير ActionsMenu ===== *@
                <template x-for="act in [
          ...(toolbar.showAdd !== false && toolbar.add ? [toolbar.add] : []),
          ...(toolbar.showAdd1 !== false && toolbar.add1 ? [toolbar.add1] : []),
          ...(toolbar.showAdd2 !== false && toolbar.add2 ? [toolbar.add2] : []),
          ...(toolbar.showEdit !== false && toolbar.edit ? [toolbar.edit] : []),
          ...(toolbar.showEdit1 !== false && toolbar.edit1 ? [toolbar.edit1] : []),
          ...(toolbar.showEdit2 !== false && toolbar.edit2 ? [toolbar.edit2] : []),
          ...(toolbar.showDelete !== false && toolbar.delete ? [toolbar.delete] : []),
          ...(toolbar.showDelete1 !== false && toolbar.delete1 ? [toolbar.delete1] : []),
          ...(toolbar.showDelete2 !== false && toolbar.delete2 ? [toolbar.delete2] : []),
          ...(toolbar.showPrint !== false && toolbar.print ? [toolbar.print] : []),
          ...(toolbar.showPrint1 !== false && toolbar.print1 ? [toolbar.print1] : []),
          ...(toolbar.customActions || [])
          ].filter(a => a && a.show !== false && (a.placement ?? 'Button') !== 'ActionsMenu')"
    :key="act.label">

    <button type="button"
            class="btn"
            :class="'btn-' + (act.color ?? 'secondary')"
            x-on:click="doAction(act, act.requireSelection ? getSingleSelection() : null)"
            :disabled="act.requireSelection && selectedKeys.size !== 1">
        <i :class="act.icon"></i>
        <span x-text="act.label"></span>
    </button>
</template>

                @* ===== زر الإجراءات: يظهر إذا فيه أي Action Placement=ActionsMenu ===== *@
                <template x-if="[
          ...(toolbar.showAdd !== false && toolbar.add ? [toolbar.add] : []),
          ...(toolbar.showAdd1 !== false && toolbar.add1 ? [toolbar.add1] : []),
          ...(toolbar.showAdd2 !== false && toolbar.add2 ? [toolbar.add2] : []),
          ...(toolbar.showEdit !== false && toolbar.edit ? [toolbar.edit] : []),
          ...(toolbar.showEdit1 !== false && toolbar.edit1 ? [toolbar.edit1] : []),
          ...(toolbar.showEdit2 !== false && toolbar.edit2 ? [toolbar.edit2] : []),
          ...(toolbar.showDelete !== false && toolbar.delete ? [toolbar.delete] : []),
          ...(toolbar.showDelete1 !== false && toolbar.delete1 ? [toolbar.delete1] : []),
          ...(toolbar.showDelete2 !== false && toolbar.delete2 ? [toolbar.delete2] : []),
          ...(toolbar.showPrint !== false && toolbar.print ? [toolbar.print] : []),
          ...(toolbar.showPrint1 !== false && toolbar.print1 ? [toolbar.print1] : []),
          ...(toolbar.customActions || [])
          ].some(a => a && a.show !== false && a.placement === 'ActionsMenu')">

    <div class="relative" x-data="{ open:false }">
        <button type="button"
                class="btn btn-outline-secondary"
                x-on:click="open = !open">
            <i class="fa fa-ellipsis-v"></i>
            الإجراءات
        </button>

        <div x-show="open"
             x-transition
             x-on:click.outside="open=false"
             class="absolute right-0 z-50 mt-2 w-56 rounded border bg-white shadow">

            <template x-for="act in [
                      ...(toolbar.showAdd !== false && toolbar.add ? [toolbar.add] : []),
                      ...(toolbar.showAdd1 !== false && toolbar.add1 ? [toolbar.add1] : []),
                      ...(toolbar.showAdd2 !== false && toolbar.add2 ? [toolbar.add2] : []),
                      ...(toolbar.showEdit !== false && toolbar.edit ? [toolbar.edit] : []),
                      ...(toolbar.showEdit1 !== false && toolbar.edit1 ? [toolbar.edit1] : []),
                      ...(toolbar.showEdit2 !== false && toolbar.edit2 ? [toolbar.edit2] : []),
                      ...(toolbar.showDelete !== false && toolbar.delete ? [toolbar.delete] : []),
                      ...(toolbar.showDelete1 !== false && toolbar.delete1 ? [toolbar.delete1] : []),
                      ...(toolbar.showDelete2 !== false && toolbar.delete2 ? [toolbar.delete2] : []),
                      ...(toolbar.showPrint !== false && toolbar.print ? [toolbar.print] : []),
                      ...(toolbar.showPrint1 !== false && toolbar.print1 ? [toolbar.print1] : []),
                      ...(toolbar.customActions || [])
                      ].filter(a => a && a.show !== false && a.placement === 'ActionsMenu')"
                :key="act.label">

                <span class="sf-tipwrap"
                      :data-tip="(act.requireSelection && selectedKeys.size !== 1) ? 'يتطلب اختيار صف' : null">

                    <button type="button"
                            class="w-full px-3 py-2 text-right hover:bg-gray-100"
                            x-on:click="doAction(act, act.requireSelection ? getSingleSelection() : null); open=false"
                            :disabled="act.requireSelection && selectedKeys.size !== 1">
                        <i :class="act.icon"></i>
                        <span x-text="act.label"></span>
                    </button>

                </span>
            </template>
        </div>
    </div>
</template>

            </div>
        </div>
    }

    @* ================= TABLE ================= *@
    <div class="table-box">
        <table class="sf-table">
            <thead x-show="showHeader" class="table-head">
                <tr>
                    <th x-show="selectable" class="th-cell"></th>

                    <template x-for="col in visibleColumns()" :key="col.field">
                        <th class="th-cell"
                            :style="col.width ? `width:${col.width}` : ''"
                            :class="col.sortable ? 'cursor-pointer' : ''"
                            x-on:click="toggleSort(col)">
                            <div class="th-inner flex items-center justify-center gap-1">
                                <span x-text="col.label"></span>
                                <template x-if="col.sortable && sort.field===col.field">
                                    <i class="fas ml-1 text-xs text-gray-400"
                                       :class="sort.dir === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </template>
                            </div>
                        </th>
                    </template>
                </tr>
            </thead>

            <tbody>
                <template x-if="loading">
                    <tr>
                        <td :colspan="visibleColumns().length + (selectable?1:0)" class="td-loading">
                            <i class="fa fa-spinner animate-spin"></i> جاري التحميل...
                        </td>
                    </tr>
                </template>





                <template x-if="!loading && error">
                    <tr>
                        <td :colspan="Math.max(1, visibleColumns().length + (selectable ? 1 : 0))"
                            class="td-empty">
                            <div class="flex items-center justify-center py-6">
                                <span x-text="error"></span>
                            </div>
                        </td>
                    </tr>
                </template>






                <template x-if="!loading && !error && rows.length===0">
                    <tr>
                        <td :colspan="visibleColumns().length + (selectable?1:0)" class="td-empty">
                            لا توجد بيانات.
                        </td>
                    </tr>
                </template>

                <template x-for="(row, idx) in rows" :key="row[rowIdField] ?? idx">
                    <tr class="tr-row"
                        x-bind:class="[isSelected(row) ? 'tr-row-selected' : '', applyStyleRules(row, null, 'row')]"
                        x-on:click="toggleRow(row)"
                        style="cursor:pointer;">
                        <td x-show="selectable" class="td-cell">
                            <input type="checkbox"
                                   class="sf-checkbox"
                                   :checked="isSelected(row)"
                                   x-on:click.stop="toggleRow(row)" />
                        </td>

                        <template x-for="col in visibleColumns()" :key="col.field">
                            <td class="td-cell"
                                x-bind:class="[col.align,col.truncate ? 'truncate-cell' : '',applyStyleRules(row, col, 'cell'),enableCellCopy ? 'sf-copy-cell' : '',enableCellCopy ? 'hover:bg-gray-50' : '']"
                                x-on:dblclick.stop="enableCellCopy && copyCell(row, col, $event)"
                                x-html="formatCell(row, col)">
                            </td>


                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    @* ================= PAGINATION ================= *@
    <div class="pagination" x-show="showFooter">
        <div class="pagination-info">
            <span class="pagination-range" x-text="rangeText()"></span>
        </div>
        <div class="pagination-nav">
            <button class="btn btn-secondary" x-on:click="firstPage()" :disabled="page<=1">الأولى</button>
            <button class="btn btn-secondary" x-on:click="prevPage()" :disabled="page<=1">السابق</button>
            <span class="page-text">صفحة <span x-text="page"></span> من <span x-text="pages"></span></span>
            <button class="btn btn-secondary" x-on:click="nextPage()" :disabled="page>=pages">التالي</button>
            <button class="btn btn-secondary" x-on:click="lastPage()" :disabled="page>=pages">الأخيرة</button>
        </div>
    </div>


    @* ================= MODAL ================= *@
    <template x-teleport="body">
        <template x-if="modal.open">
            <div class="sf-modal-backdrop" x-transition.opacity>
                <div class="sf-modal" role="dialog" aria-modal="true" x-transition>
                    <div class="sf-modal-header">
                        <h3 x-html="modal.title"></h3>
                        <button type="button" class="sf-modal-close" x-on:click="closeModal()">✕</button>
                    </div>

                    <div class="sf-modal-body">

                        <template x-if="modal.message">
                            <div class="mb-7 flex items-center justify-center gap-2 rounded-sm px-4 py-2 text-center"
                                 :class="modal.messageClass || 'border border-sky-200 bg-sky-50 text-sky-700'">
                                <i x-show="modal.messageIcon"
                                   :class="modal.messageIcon"
                                   class="text-lg opacity-90"></i>
                                <span x-text="modal.message"></span>
                            </div>
                        </template>

                       
                        <template x-if="modal.loading">
                            <div class="td-loading">
                                <i class="fa fa-spinner animate-spin"></i>
                                جاري التحميل...
                            </div>
                        </template>



                        <template x-if="!modal.loading && !modal.error && modal.html">
                            <div x-html="modal.html"></div>
                        </template>

                    </div>
                </div>
            </div>
        </template>
    </template>


</div>
