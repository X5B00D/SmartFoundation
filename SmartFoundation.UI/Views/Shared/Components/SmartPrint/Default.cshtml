@model SmartFoundation.UI.ViewModels.SmartPrint.SmartPrintConfig
@using SmartFoundation.UI.ViewModels.SmartPrint
@using Microsoft.AspNetCore.Html

@* هذا القالب هو الغلاف العام لنظام الطباعة (SmartPrint)، يعرض عنوان وأزرار الطباعة ثم يمرّ على جميع التقارير المرسلة ويختار القالب المناسب لكل تقرير حسب نوعه (مثل تقرير A4 طولي)، مع التعامل مع حالات التحميل، الخطأ، وعدم وجود بيانات *@
@* SmartFoundation\SmartFoundation.UI\Views\Shared\Components\SmartPrint *@

<div id="@Model.PrintId" class="w-full rounded-sm border border-gray-100 bg-white p-4" dir="@Model.Dir">

    @if (!string.IsNullOrWhiteSpace(Model.Title) || (Model.Actions?.Any(a => a.Show) == true))
    {
        <div class="mb-3 flex items-start justify-between gap-2">
            <div class="min-w-0">
                @if (!string.IsNullOrWhiteSpace(Model.Title))
                {
                    <div class="truncate text-sm font-semibold text-gray-800">@Model.Title</div>
                }
            </div>

            <div class="flex items-center gap-2">
                @foreach (var a in (Model.Actions ?? new()).Where(x => x.Show))
                {
                    @RenderAction(a)
                }
            </div>
        </div>
    }

    @* Docs *@
    <div class="grid grid-cols-12 gap-4">
        @foreach (var doc in (Model.Docs ?? new List<PrintDocConfig>()))
        {
            <div class="col-span-12" dir="@doc.Dir">
                @if (!string.IsNullOrWhiteSpace(doc.ErrorMessage))
                {
                    <div class="rounded-xl border border-red-200 bg-red-50 p-4">
                        <div class="text-sm font-semibold text-red-700">??? ???</div>
                        <div class="mt-1 text-xs break-words text-red-600">@doc.ErrorMessage</div>
                    </div>
                }
                else if (doc.IsLoading)
                {
                    <div class="animate-pulse space-y-3">
                        <div class="h-4 w-2/3 rounded bg-gray-200"></div>
                        <div class="h-3 rounded bg-gray-100"></div>
                        <div class="h-3 rounded bg-gray-100"></div>
                        <div class="h-3 rounded bg-gray-100"></div>
                    </div>
                }
                else if (doc.IsEmpty)
                {
                    <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
                        <div class="text-sm font-semibold text-gray-700">?? ???? ??????</div>
                        <div class="mt-1 text-xs text-gray-500">@((doc.EmptyMessage ?? "?? ???? ??????"))</div>
                    </div>
                }
                else
                {
                    @switch (doc.Type)
                    {
                        case PrintDocType.A4PortraitReport:
                            @await Html.PartialAsync("~/Views/Shared/Components/SmartPrint/Docs/_A4PortraitReport.cshtml", doc)
                            break;

                        default:
                            <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
                                <div class="text-sm font-semibold text-gray-700">??? ????? ??? ?????</div>
                                <div class="mt-1 text-xs text-gray-500">PrintDocType: @doc.Type</div>
                            </div>
                            break;
                    }
                }
            </div>
        }
    </div>
</div>

@functions {
    IHtmlContent RenderAction(PrintAction a)
    {
        var icon = string.IsNullOrWhiteSpace(a.Icon) ? "" : $"<i class='{a.Icon} text-xs'></i>";
        var text = string.IsNullOrWhiteSpace(a.Text) ? "" : $"<span class='text-xs'>{a.Text}</span>";

        var cls = string.IsNullOrWhiteSpace(a.CssClass)
            ? "inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-gray-700 hover:text-gray-900 hover:border-gray-300 bg-white"
            : a.CssClass;

        if (!string.IsNullOrWhiteSpace(a.Href))
        {
            var target = a.OpenNewTab ? " target=\"_blank\" rel=\"noopener\"" : "";
            return new HtmlString($"<a class=\"{cls}\" href=\"{a.Href}\" title=\"{a.Title ?? ""}\"{target}>{icon}{text}</a>");
        }

        var onclick = string.IsNullOrWhiteSpace(a.OnClickJs) ? "" : $" onclick=\"{a.OnClickJs}\"";
        return new HtmlString($"<button type=\"button\" class=\"{cls}\" title=\"{a.Title ?? ""}\"{onclick}>{icon}{text}</button>");
    }
}
